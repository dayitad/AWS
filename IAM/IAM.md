## Security, Identity and Compliance > IAM

**IAM** is Identity and Access management is AWS. It is the central point for security in AWS. Every service uses IAM for security.
IAM has 3 main components - users, roles and groups.

+ Users - Physical user or a physical person, **never a root account since root account has all permissions**. Users must be created with proper permissions.
Create User > Manage User > Add User - Programmatic and console access > Autogenerated password > reset on login > attach policy > admin access. This user can be used to access AWS, not the root account. Also note that we can change the alias or URL for the user and share that which the user can use to login. To set password policy for user passwords, Account Setting > Password policy. An IAM user can belong to multiple groups.
+ Roles - They are for internal usage by aws resources and services. **They are given to machines**.
+ Groups - Contains users. They can be functions(admin, devops) or teams(engineering, finance) or any other attribute by which users can be grouped. We can apply permissions to groups and all users under that group will inherit those permissions. Groups > Manage Group > Create New Group > name it > Add administrator access policy > Add user to group - the user will automatically inherit group permissions.

**Policies** are JSON documents which define permissions, what each of these users, groups or roles can do. They are assigned these policies. IAM has many predefined policies which can be reused. 
IAM is a **global** service.  The IAM users, groups or roles are valid across all regions.   

**Best Practices :**
+ Enable MFA for root account(Root User > Virtual MFA > Google Authenticator) and never use it as a user.
+ It is best to follow least privilege principle, that is give users, groups or roles minimal required permissions needed to perform their job. It is not recommended to over empower them.

#### IAM Federation
Big enterprises use IAM federation. They integrate their own repository of users , usually active directory with IAM so that their users can use company credentials to login to AWS. It uses SAML standard.

#### Brain DUMP - IAM
+ User mean Physical Person, Role means machine
+ 1 IAM user per physical person and 1 IAM role per application. 
+ IAM credentials should not be shared.
+ Never use root account apart from setup and never use it as a user or a role.
+ Never, ever **embed IAM credentials in code**.

<img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/IAM_Basics.png" width="60%" height="60%"/>

#### AWS STS - Security Token Service

+ AWS STS is in the backbone of all the other AWS services. STS stands for Security Token Service.
+ STS allows you to grant limited and temporary access to AWS resources. And they will issue a token.
+ The token will be temporary, valid up to one hour. So if you want to reuse that token, the token must be refreshed, and so the credentials must be re-verified before you have a new token that allows you to access your AWS resources.
+ There is a bunch of API in STS
	+ AssumeRole 
		+ You can use the AssumeRole within your own account for enhanced security, for example you have your users assume a role that allows them to delete EC2 instances, so the reason we do this is that we want
	      to have an extra layer of security, such as they don't accidentally delete EC2 instances. They have to assume a role first to do that.
	    + You can use AssumeRole for cross account access. And in that case, we assume a role in a target account, which is not our account, and because we have assumed a role there, we can perform actions
	      on the resources of that account.
	+ AssumeRoleWithSAML
		+ This is helpful to return credentials, when our users are federated through SAML.
 	+ AssumeRoleWithWebIdentity
 		+ This is to return credentials for users that are going to be logged in through an identity provider such as Facebook Login, Google Login or any OIDC compatible login. And it's going to return us credentials,
 		  but AWS recommends against using this, and we have to use cognitive instead and that is the most recommended way.
 	+ GetSessionToken
 		+ This is for multi-factor authentication, for a user or AWS account root users. So anytime your users have MFA, they have to use GetSessionToken, to get a token allowing them access to the console or 
 		  through the CLI.
 + STS is really at the center of providing our users and our applications, tokens that allow them to talk to our AWS resources.
 + Usecase - How to Assume a Role
 	+ First, we define an IAM role; it could be within your account or a cross-account
 	+ Define which principles can access this IAM role, so which users, which other roles can access this IAM role
 	+ Then you use the STS service to retrieve credentials and impersonate the IAM role, and this is using the AssumeRole API.
 	+ The credentials will be valid for between 15 minutes to one hour based on how you configure your AssumeRole API.
   <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/STS.png" width="60%" height="60%"/>
 + So we have the user, and it wants to assume a role within the same account or other accounts using the AssumeRole API and invoke STS. STS is going to check with IAM if we have the permissions to do so,
   then it will return us temporary credentials, and these credentials can be used to access that role in our account. So we can see the whole process, we first ask stuff from STS who checks with IAM,
   returns us security credentials, and then we are able to assume that role and endorse it. This is very very similar when you have cross account access. We have a production account on the left hand side,
   and a development account on the right hand side. And as we can see, the first thing to do is that the admin will create a role in the production account. Then the admin in the development account will create a
   developer's group with the permission to access this UpdateApp role. Then the user will request access to the role. STS will return the role credentials, so now we have the credentials to use that role
   in this account, and then the user using these new credentials can access, for example, an extra bucket in the other account. So this is a process for cross account access and is done using STS so you never 
   share credentials across accounts. You create a role, and you make sure that your user assumes that role, and STS will return to you, role credentials that are temporary so even if you somehow lose them, then 
   it is not as bad as leaking entire credentials of an account. https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html
   <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/STS_CA.png" width="60%" height="60%"/>

#### Identity Federation and Cognito

+ We've seen in AWS, how to create users with AWS accounts to access our services. But, sometimes we want identity federation. Because you don't want to manage all you users within AWS.
+ You want to have an external source of truth for users and allowing them through that source of truth to access your AWS resources. So federation let's users outside of AWS assume temporary roles
  for accessing AWS resources.
+ And these users assume identity provided access roles.
+ There are many ways to do federation in AWS.
	+ SAML 2.0
	+ Custom Identity Broker
	+ Web Identity Federation with or without Cognito
	+ Single Sign On
	+ Non-SAML with AWS Microsoft AD.
+ Using user federation, you don't need to create IAM users as the user management is outside of AWS.
+ At a very very high level, We have our user and we have a 3rd party source for our users. AWS is going to trust that 3rd party source for managing our users. The users will login to the 3rd party,
  get credentials from it and be able to access AWS this way. Here, the user management is outside of our AWS account.
  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/FED_1.png" width="60%" height="60%"/>
+ The first very common way to do federation is to use SAML 2.0.
	+ Using SAML 2.0 federation, we can get access to the AWS console or the CLI using temporary credentials.
	+ There's no need to create an IAM user for each of your employees. Active Directory is a very common way of having users on premise. And so, you create your users on Active Directory and they 
	  will be able to access AWS thanks to SAML 2.0 federation.
    + https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_saml.html
    + <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SAML.png" width="60%" height="60%"/>
      Our client application wants to get access to an Amazon S3 buckets within AWS. But, the user management is done outside onpremise in your organization. So, the client app will send a request 
      to your identity provider to authenticate and your identity provider will check with LDAP to ensure that you're correctly authenticated. Then, it will return back what's called a SAML assertion.
      We'll retrieve a SAML 2.0 assertion and the client has it. It is going to exchange that SAML assertion for some AWS credentials by calling the AssumeRole with SAML STS API. STS will look at 
      the SAML assertion, will make sure that its correct in compliance with the trust it has and then return temporary security credentials, which can be used to access the Amazon S3 Bucket.
    + <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SAML_2.png" width="60%" height="60%"/>
      We do same thing for accessing console. The browser again will authenticate with our LDAP and our identity provider, which will return a SAML 2.0 assertion. Then client is going to post this 
      SAML assertion automatically to the sign in URL of AWS, which will check with STS to give us some temporary credentials and the client is redirected to the AWS management console.
      https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_enable-console-saml.html
    + So both usecases work exactly the same way. We first authenticate within our organization, and we exchange the SAML 2.0 assertion for some temporary credentials with AWS STS and then we are 
      able to access resources or the console.
    + SAML 2.0 has great integration with Active Directory or ADFS. It is the exact same process.
      <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SAML_3.png" width="60%" height="60%"/>
      	+ https://aws.amazon.com/blogs/security/aws-federated-authentication-with-active-directory-federation-services-ad-fs/
      	+ Our browser interface will login with ADFS and ADFS will check that our user is properly authenticated and return us a SAML response which we are going to exchange with STS with the assume role 
      	  for temporary credentials. we will then use them to either access the management console or we can access some resources within AWS specifically.
    + Uou need to setup a trust between IAM and SAML, both ways.
    + SAML 2.0 enables web based, cross domain SSO. 
    + And, it will use the STS API AssumeRoleWithSAML.
    + SAML federation is the "old way" of doing things and there is a new service called Amazon single sign on or SSO which is going to be the new way to create this federation. 
      https://aws.amazon.com/blogs/security/enabling-federation-to-aws-using-windows-active-directory-adfs-and-saml-2-0/
+ But if our current on premise store is not compatible with SAML 2.0 , then, we have to write our own Custom Identity Broker Application.
	+ This is only if you don't have compatibility with SAML 2.0.
	+ The identity broker you have to create must determine the appropriate IAM policy for your users.
	+ We can use the AssumeRole STSAPI or GetFederationToken STSAPI.
	+ https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_federated-users.html
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SAML_4.png" width="60%" height="60%"/>
	  The users will authenticate with the Identity Broker which will verify that the user is correctly authenticated. This time it's not AWS that gives us credentials , rather it's the Identity Broker 
	  that will talk to STS to request some credentials for some specific action and the Identity Broker which we will have to write ourselves will return these credentials to us and then we can access the console
	  or the AWS APIs. The Identity Broker itself is the one talking to STS and giving us back some credentials. 
+ But if we want to have users of our applications access AWS, we have to use Web Identity Federation.
	+ This is not the recommended way to correctly do Web Identity Federation. AWS recommends that we now use Cognito instead of this method. The reason is, Cognito allows access for anonymous users,
	  data synchronization and multi-factor authentication.
	+ https://docs.amazonaws.cn/en_us/amazondynamodb/latest/developerguide/WIF.html
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/WIF.png" width="60%" height="60%"/>
	  Here our mobile client which is an app is going to login through Facebook or Google or Amazon.com, anything. And then it's going to get back some credentials, a token.
	  And that token is going to be exchanged with STS using the AssumeRoleWithWebIdentity. So, STS is going to look at this, say yes, I trust this login, let me return to you some AWS credentials.
	  And now, the mobile client has some AWS credentials and can access a different IAM policy and then maybe a dynamodb table which is your GameScores. So, the idea here is that its a 3-way process,
	  we first login with our identity provider, we then exchange it with a STS, and then we have access to AWS. But the recommended way is to use Cognito.
+ AWS Cognito
	+ With cognito the goal is to provide direct access to AWS resources from the client side. It could be your mobile or web application.
	+ Cognito is made to federate mobile user accounts and provide them with their own IAM policy.
	+ For example, we want to provide temporary access to write to S3 bucket using a Facebook login because its more efficient if our clients have direct access to the S3 buckets.
	+ The problem is, we do not want to create IAM users for applications in your accounts. Imagine you have millions of users for your application and you don't want to create one IAM user for each application user. This is why we use 
	  Identity Federation.
	+ How do we do it 
		+ We are going to login to our identity provider or even remain anonymous.
		+ And then, from the Cognito API, we are going to get back AWS credentials.
		+ And then, the credentials will come with IAM role so we can access our S3 buckets.
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/COG.png" width="60%" height="60%"/>
	  We have our application, it could be a mobile application or a web application and, its going to login with an identity provider. The identity provider can be Google, Facebook, Amazon, Twitter, SAML, Open ID or 
	  even Cognito User Pool(CUP). We login with it and we get back a token, so the login is user name, password. We get back this token, and this token can be exchanged with Cognito Federated Identity which is going to verify the token 
	  first, then get credentials from STS in the backend. And, give us back some temporary AWS credentials. And, these credentials themselves can be used to access our Amazon S3 bucket thanks to the policy we have attached to this role.
	  So, this is fairly similar, but now Cognito is going to be at the center of Web Identity Federation.

#### Directory Servies

+ Microsoft Active Directory
	+ Microsoft AD is a software that is found on any Windows server with AD Domain Services.
	+ It's a database of objects, and the objects can be user accounts, computers, printers, file shares, security groups. So all your users managed within your entire Microsoft ecosystem on-premise
	  is going to be managed by Microsoft Active Directory.
	+ There's going to be a centralized security management. You can create accounts, assign permissions and so on.
	+ All the objects will be organized into a tree and a group of trees is called a forest.
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/AD.png" width="60%" height="60%"/>
	  We have a domain controller and we're going to create an account on it. We'll create an account, user name is John as the password is password.
	  And the idea is that all the other Windows machines we have within our network are going to be connected to the domain controller, so if we're using the username as John and its password on the first machine
	  it's going to look it up in the controller and say yes, we have that login, and then allow you to log in from that machine. So all these machines are going to be connected to your domain controller,
	  and that allows you to have the users accessible on any single machine.
+ AWS Directory Services
	+ This is to provide you a way to create an Active Directory on AWS. There are three flavors on it.
		+ The first one is AWS Managed Microsoft AD to create your own Active Directory in AWS. And you can manage your users locally, and it supports multi-factor authentication.
		  The idea is that with this standalone Active Directory you can also create a trust connection with your on-premise AD, where you have your own users there as well. And what that means is that your AD,
		  in here for example, can be trusted with the on-premise AD. So AWS trusts the on-premise AD and on-premise AD trusts AWS. So that means that if your users use an account that is not managed by AWS,
		  it can go and look up the accounts into the on-premise Active Directory. And similarly, if an on-premise directory user goes and authenticates your on-premise AD using the AWS accounts, it can be trusted 
		  to go and look it up. So here our users are going to be shared between our on-premise Active Directory and AWS.
		+ The AD connector is a little bit different. This is a direct gateway proxy to redirect to the on-premise AD, and the users are solely managed into the on-premise AD. Our AD connector is just acting as a proxy, 
		  so if the users start to authenticate with our AD connector, it's going to proxy the request back to our on-premise AD and look it up. So the idea here is that in the first case with Managed Microsoft AD
		  we have users sitting in AWS Managed AD and users sitting in on-premise AD, whereas with AD Connector, as the name indicates, it connects, it proxies the queries, the connection requests, back to our 
		  on-premise Active Directory, and the only place where we can manage users is going to be on the on-premise AD.
		+ Finally, you have Simple AD, and it's an AD-compatible managed directory on AWS. It doesn't use Microsoft Directory, and it cannot be joined with an on-premise Active Directory. So the idea is that if you don't have
		  an on-premise AD, and you need an Active Directory for your AWS Cloud, then you can have just a Simple AD as a standalone thing. And the idea here is that, using Active Directory, you can create EC2 instances
		  that are going to be running Windows, and these Windows instances can join the domain controllers for your network and share all the logins and the credentials and so on. So this is why you want to have a directory 
		  in AWS, to have a directory closer to your EC2 instances running Windows.
	+ |AWS managed Microsoft AD|AD Connector|Simple AD|
	  |------------------------|------------|---------|
	  |<img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/1.png" width="60%" height="60%"/>|<img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/2.png" width="60%" height="60%"/>|<img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/3.png" width="60%" height="60%"/>|
	+ If the exam asks you that  we want to proxy our users to on-premise, you need AD Connector, or we want to manage our users on the cloud in AWS and have MFA, you need AWS Managed AD or we just want a Simple AD
	  and we don't have any on-premise stuff, in this case, you want a Simple AD.
+ Handson - Go to Directory Service - We have 4 options
	+ AWS Managed Microsoft AD where we can have an Active Directory that's going to be integrated with AWS Cloud and can have a trust relationship with your on-premise directory.
	  And to set it up, you can see it's two editions, the Standard Edition up to 30,000 objects or the Enterprise Edition up to 500,000 objects. This supports MFA. 
	+ Then we have Simple AD which is going to be a standalone managed directory that has an Active Directory-compatible API, but it cannot be connected to your on-premise Active Directory. This is standalone.
	+ AD Connector, which is a proxy for redirecting directory requests to your existing Microsoft Active Directory on-premise. You have two levels, you have a Connector for up to 500 users. This is just a proxy.
	+ Amazon Cognito User Pools

#### Organizations

+ So let's get into the multi-account realm with AWS Organizations.
+ AWS Organizations is a global service
+ It is allowing you to manage multiple AWS accounts in your organization.
+ The main account is going to be called, the Master account and you cannot change it,
+ The other accounts within your organizations are member accounts.
+ The member accounts can only be part of one organization. Although, they can be moved from one organization to another, it's called a migration. 
+ Benefits of organizations is that you get Consolidated Billing across all the accounts and with a single payment method. So you can have as many accounts as you want and they will all be billing under the master accounts.
+ The pricing benefits you get from aggregated usage, for example, if you have volume discount for EC2 or Amazon S3, you get it at the organization level. So, it's really great to federate all these accounts into one organization
  to pay less and simplify your billing methods.
+ And there's a really cool API that allows you to automate the AWS account creation. So, you can create AWS account on demand using an API through organization and make sure that the billing of that account will be rolled back 
  into the bigger accounts.
+ Multiple Account Strategies
	+ You may want to create one account per department or per cost center or per environments, for example, for dev, test and prod, or based on regulatory restrictions(SCP), for example, or for better resource isolation(VPC).
	  So, you want to make sure that you don't have resources that can talk to each other within the same VPC. So, you create two accounts and you don't pair them together. And so, the resources are virtually-isolated.
	  There's also good to have per-account services limits and also, isolated accounts for logging.
	+ There is a difference between having multiple accounts or one account with multiple VPC in it. If you have multiple accounts, you know they're really well-separated and you have different user accounts and so on.
	  Whereas, if you have one giant account with multiple VPC, there is a chance that your resources may talk to one another, and instances and users get access to multiple VPCs and so on.
	+ You can have also, tagging standards for billing purposes.
	+ You can enable CloudTrail on all accounts to send the logs to a central S3 account 
	+ You can also have CloudWatch logs sent to central logging accounts.
	+ If you wanted to administer all of the accounts, then you can establish Cross Account Roles for admin purposes, where the master accounts can assume an admin role into any of the children accounts.
+ Organizational Units(OU) - We organize all these accounts using Organizational Units or OU.
	+ https://aws.amazon.com/answers/account-management/aws-multi-account-billing-strategy/
	+ You can organize them by business units e.g. : We have the master account and then we have the sales OU, the retail OU and the finance OU. And under each OU, we have different accounts.
	  So, the sales account one, two, retail account one, two and so on.
	+ You can have it by environment, e.g. : you have the master account and then you're gonna have production, development OU and test OU. And within each OU, again, multiple accounts.
	+ You can be project-based. Project one, project two, project three, and multiple accounts.
	+ You can mix and match and it's really up to you to design the type of OU you want.
	  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/OU.png" width="60%" height="60%"/>
	+ So, for your organization, let's have a look at all the possibilities. You have the root OU, we have the root account as the master account, and then you can have OUs within this.
	  For example, a development OU with two accounts in it, the Prod OU with two accounts in it, and another OU deep within the Prod, which is the finance OU, with another two account in it
	  and another OU within Prod again, which is the HR OU with two accounts in it.
	  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/OU1.png" width="60%" height="60%"/>
	+ You can assign accounts to whatever OU you want and they will inherit some rules and some SCP.
+ Service Control Policy(SCP)
	+ It allows you to white-list or black-list IAM actions
	+ It is applied at the root OU or account level
	+ It doesn't apply to the Master account, the SCPs have no effects on the Master account.
	+ The SCPs can be applied to only the users and the roles of the account, including the root.
	  So, if you apply an SCP onto your account within an OU, e.g. you cannot use EC2, even an admin within that account cannot use EC2.
	+ But the SCP does not apply to service-linked role. So, this is the service roles that other services use to interact with organizations.
	+ SCP must have an explicit Allow to allow things. So by default, it does not allow anything.
	+ Use cases for SCP
		+ Restrict access to certain services. For example, you're saying, "Okay, in my production accounts, you cannot use EMR."
		+ Enforce PCI compliance by explicitly disabling services that are not compliant with PCI yet in AWS.
	+ SCP Hierarchy
		+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SCP.png" width="60%" height="60%"/>
		  Let's have a look at our OU. So, we have the root OU with a root account, a production OU with an account A in it, and with an HR OU with account B, and a finance OU with account C.
		  So, let's assume that on the root OU, you add an SCP called FullAWSAccess which tells that every services and every action can be done. But, let's apply a DenyAccessAthena SCP
		  onto the Master accounts. Now what can the Master account do or cannot do? Well, the Master account can do anything because it inherited the Full Access SCP from the root OU,
		  and even though we have attached to DenyAccessAthena SCP to the Master account, because it is the Master account of your route OU, no SCP apply and therefore this SCP applied
		  to the Master account is not taken into account. We've inherited stuff from the root OU and the SCP applied to the Master account, ToDenyanything does not apply.
		  Now let's go on, we have a DenyRedshift SCP that is applied to the prod OU. And an AuthorizeRedShift SCP applied to the account A. So now about account A, it can do anything because 
		  you have FullAccess SCP. But it cannot access Redshift because there is a DenyRedshift SCP applied to the prod OU. And even though I would attach an AuthorizeRedshift SCP to my account A
		  because we have an explicit Deny on Redshift at the OU level, the Deny is going to take precedence over the Authorize. So even though I have this AuthorizeRedshift SCP
		  on the account A, actually that Authorize is useless because we already have a Deny at the OU level. So account A going to inherit the SCP at its level, at the OU level
		  and even the roots of the OU, so it goes like a tree. And so if one of these says, "Deny," then it's going to be a Deny. Now let's look at HR OU, it has a DenyAWSLambda SCP.
		  And so what about account B? Well, it can do anything because of the Full Access, but it cannot access Redshift because it's within the prod OU, it's the bigger OU. And also, it cannot 
		  access AWS Lambda because it's within the HR OU. Account C though, in finance OU is not affected by this DenyAWSLambda SCP because it only applied to the HR OU but not the finance OU.
		  And therefore account C, has the exact same permission as account A, which is to do anything but access RedShift.
	+ SCP Examples
		+ https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_example-scps.html
		+ An SCP looks just like IAM policy.
		  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SCP_1.png" width="60%" height="60%"/>
	+ Moving Accounts
		+ We have Org A and Org B, and we want to move an account from Org A to Org B.
		  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/MIG.png" width="60%" height="60%"/>
		+ To migrate accounts from one organization to another
			+ Remove the member accounts from the old organization
			+ Then you send an invite to the new organization to include that account.
			+ And then you accept the invite to the new organization from the member account.
		+ If you want to migrate the master account of the old organization to the new organization
			+ You need to migrate every single accounts within it. So you remove the member accounts from the organizations using above procedure
			+ You delete the organization 
			+ Repeat the process above to invite the old master account to new org
+ Handson
	+ We have created a master account called AWS_master. Then we go to AWS Organization and create Organization. We have to verify our master account by email. We can see that we have only one account
	  designated by a star since it is a master account. We are now going to add account by inviting exisiting accounts or creating new accounts. So we invite an account called AWS_child and give email or account id
	  and an email is sent out.  Once we accept under the AWS Organization > invitaions tab of the account invited, we have joined the organization. We can see the child account now in our master account.
	+ We now go to Organize accounts tab and create 3 new Organizational unit with names DEV, TEST and PRD. By default we have a root OU which is the top most OU. These OUs are below root. Withing Prd,
      we can add more OUs like Finance and HR. For each OU, we can have a set of accounts. Now we move the AWS_child account to HR under PROD under root. The aws_master account is left under root. We are going
      to nable service control policies in root.  We can attach these policies to different places in my OU and the permissions will be rolled down. So for the SCP in root, we see that FullAWSAccess is enabled by default.
      We will not touch this. Now in PRD > HR ou, we attach a SCP policy by creating a new policy which will deny access to Athena. So any account under HR like AWS_child will have full aws access but no athena access
      inherited from HR OU.

#### IAM - Advanced

+ IAM conditions are ways to make your IAM policies a bit more restrictive based on a condition.
	+ aws:SourceIP is to restrict the client IP from where the API calls are being made. So in this example we deny everything, and the condition is when IP address
	  is not within these two IP ranges. In English it means deny anything that does not come from these two SourceIP ranges. We don't deny everything all the time, we just deny it if they don't come from
	  a predefined list of IPs and this is for enhanced security. 
	+ aws:RequestedRegion which is to restrict the region the API calls are made to. In this example calls are allowed only inside the EU. The effect is allow and actions are ```EC2 : * RDS : * DynamoDB : *```,
	  so anything is allowed on these 3 service. We have ```Resource*``` , so any resources within these three services should be allowed. Conditions are only if strings equal requested region EU Central 1 or EU West 1.
	  So this means if you are making an API call on these services on anything and it has to come from these requested regions, so either EU Central 1 or EU West 1, then accept it. Otherwise if it comes from the US 
	  or anything like this then don't accept it. So here in aws:RequestedRegion we don't see where the client is located, we see where the client is trying to make an API call to. So that means the client can only operate
	  in EU West 1 or EU Central 1.
	  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/C1.png" width="60%" height="60%"/>
	+ Restriction based on tags - ec2:ResourceTag or aws:PrincipalTag - So we are able to say okay, you can start and stop your EC2 instances only and only if your project is data analytics and your department is data
	  and that's for the resource tag of your EC2 instance and the principal tag of your user. So we are able to have tag based security in aws.
	+ Multi factor authentication - aws:MultiFactorAuthPresent - so we're saying okay, you can stop instances and terminate instances only if you have multi factor authentication present, and deny if you don't have it.
	  The very good thing about IAM policies is that you can usually read them out loud by just seeing what is written but you should know that the SourceIP is for where the client is located and the requested region is
	  where you're trying to make request to.
	  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/C2.png" width="60%" height="60%"/>

+ IAM for S3
	+ ListBucket is a permission that applies to the bucket test and as such the arn is arn:aws:s3:::test because that's where our bucket is. This is a bucket level permission and so there's no trailing slash, it's just the bucket name.
	+ But GetObject, PutObject and DeleteObject applies to anything within a bucket and so therefore the arn, the resource you should consider is the name of the bucket, slash and then a star because it applies to all the 
	  objects within the bucket. The star says the PutObject, GetObject and DeleteObject applies to any object within your bucket. This is an object level permission.
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/S3.png" width="60%" height="60%"/>

+ Difference between an IAM Role and a Resource Based Policy - Let's assume the user is in Account A and the Amazon S3 bucket is in Accounts B and we want to access it.
    + We create a role in the Account B, assume that role using STS and then by assuming that role in Account B we will be able to issue API calls against the Amazon S3 bucket in Account B.
    + The other option is to use the same bucket and create an S3 bucket policy that allows directly the user accounts from account A to access the Amazon S3 Bucket.
    + So they look similar but they're actually a little bit different. 
    + When you assume a role (a user, an application or a service), you are going to give up your original permissions and you're going to take the permissions assigned to the role.
    + And when using a resource based policy, your principal doesn't have to give up his permissions and he can just go through that resource bucket policy and not loose their permissions. so you can do both actions in 
      Account A and Account B.
    + So for example, if user in Account A needs to scan a DynamoDB table in Account A and then dump it into an S3 bucket in Account B then there would be some use case for a resource based policy because if using IAM role
     to do some stuff in Account B for the S3 bucket , then you cannot do anything back on your DynamoDB table in Account A and that would be a waste. So what our resource based policy gonna be applied to, well Amazon 
     S3 bucket, SNS topic, SQS queues, all these things can have resource based policy.
    + <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/POL_ROLE.png" width="60%" height="60%"/>

+ IAM Policy Evaluation Logic
	+ IAM Permission Boundaries
		+ These Permission Boundaries are supported for users and roles and they're not available for groups. 
		+ Advanced feature that allow you to define the maximum amount of permissions an IAM entity can get.
		+ Example - We have a IAM Permission Boundary which looks just like an IAM policy where we're saying, allow everything on S3, CloudWatch and EC2. We have attached this to IAM user. This means
		  that it can only do things within S3 CloudWatch and EC2. And then you need to specify on top of things an IAM permission through policy. And so we attached to this very same user.
		  Allow IAM create user "Resource star". The result permission in this case will be no permissions. Because the IAM policy is outside the IAM Permission Boundary. Therefore our user is not allowed 
		  to create other IAM users because that is not in it's IAM Permission Boundary.
		  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/PB.png" width="60%" height="60%"/>
		+ We create a user, John and give him programmatic access and create. Now we are going to set a PermissionBoundary for John to have Amazon S3 full access. John has a permission policy of AdminAccess.
		  So resultant is John can only do all operations on S3 because of the permission boundary being more restrictive.
		+ IAM Permission Boundaries can be used in combinations of AWS Organizations SCP. https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html
		+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/EP.png" width="60%" height="60%"/>
		  We have the effective permissions to be in the middle of your identity based policy, the Permission Boundary and your Organization SCP which applies to every single IAM entity your account.
		  So in the middle lies what the users can do.
		+ We can use certain Permission Boundaries for a few use cases.
			+ To delegate responsibilities to non administrators within the Permission Boundary. For example, to create new IAM users.
			+ Allow developers to self assign and manage their own permissions, while making sure that it can't escalate their privileges. That means making themselves administrators.
			+ Restrict one very specific user inside your AWS Organization. Instead of applying an entire SCP to your account and restricting everyone in your whole account.
	+ How an IAM policy is going to be evaluated ? 
		+ https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html
		+ First the decision starts with Deny. So by default anything you do in AWS is going to be denied. Then we're going to look at all of the applicable policies. And if in any of these policies
		  either it could be Organizations SCP, resource based policy, IAM Permission Boundaries or session policies, your identity based policy. If in any of those we have an explicit Deny,
		  then the final decision is Deny. So explicit Deny is the most powerful thing you can do. As soon as there's a Deny that's explicit, then the decision is going to be Deny.
		  Then we look at the organizations SCP. And so we look at, is the member or principal of an Organizations SCP? If yes, if there is an "Allow" then no "Deny", else go to the next step.
		  And the next step is, is there a resource based policy? So think on S3 Bucket, and if there is an allow that's explicit into your S3 bucket policy for example, then the final decision is allow.
		  Then we go to the Permission Boundaries. So we look at the Permission Boundaries. Is there a boundary on the "Principal". And is there an "Allow" on the Permission Boundary. And if there is no Allow 
		  then it's going to be denied. Otherwise if it doesn't allow then we move on to the next step. And then identity based policies is, does the user have an explicit Allow that allows him to do,
		  you know, manage policy for example, or any line policy that allows him to do for her, a special AWS access. If yes, then the final decision is Allow. Otherwise it's going to be an implicit Deny.
		  And so this is how he evaluates an IAM policy.
		  <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/EVP.png"/>
	+ Example : 
		+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SQSE.png" width="60%" height="60%"/>
		+ We have "SQS star" , Deny on "Resource star" and we have action "SQS:DeleteQueue" Allow on "Resource star".
		+ Can you perform SQS:CreateQueue - The answer is no, you cannot. Because there is a "Deny star" on SQS. And "CreateQueue" belongs to that block and there's a "Deny" on it. So it's definitely going to be denied.
		+ Now, can you perform an SQS:DeleteQueue - So there's a Deny on the top of our part. And there's an Allow on the bottom part, right? And they conflict.But if you have an explicit Deny,
		  then the decision is going to be denied. So because there is an explicit Deny on "SQS star" and sqs:deleteQueue is within that "SQS star", then no matter what, even there's an allow here,
		  This is going to be denied this action. So you cannot perform "sqs:deleteQueue" even though you have allowed it explicitly in the second block. And finally, can you perform ec2:DescribeInstances -
		  So as we can see, there's nothing on EC2 in this vein. And this is an IAM policy. And so because there is no explicit Deny, but also there is no explicit Allow, then you cannot perform ec2:DescribeInstances
		  with this IAM policy.

#### RAM - Resource Access Manager

+ AWS Resource Access Manager or RAM is actually a very simple service.
+ It's allowing you to share AWS resources that you own with other accounts.
+ You can share with any accounts or within your organization.
+ The idea is that you avoid resource duplication.
+ So what can you share with RAM or Resource Access Manager?
	+ VPC Subnets
		+ To allow you to have all the resources launch within the same subnets
		+ They must be from within the same organization.
		+ And currently, though, you cannot share security groups or the default VPC.
		+ And then from this, the participants can manage their own resources in your shared VPC.
		+ But the participants cannot view, modify or delete resources that don't belong to them. So if the resources belong to other participants or the owner, you will not see those.
		  So you share the underlying VPC but you don't share the resources within the VPC.
	+ AWS Transit Gateway
	+ Route53 Resolver Rules
	+ License Manager Configurations.
+ Let's have a look at a concrete example and use case of how you would use Resource Access Manager. So let's take an example of the VPC. So we have an AWS account, and it's going to be the VPC owner 
  and we're going to create a VPC within that account. And the VPC will have a private subnet, where we deploy our resources. And other accounts are going to be sharing the same VPC. So account one and account two
  are going to be sharing the same VPC, thanks to Resource Access Manager. 
  + So each account will be responsible for its own resources and cannot view, modify or delete other resources in other accounts.
  + So the only thing that is shared here is the private subnet, it's the networking layer.
  + So account one can create an EC2 instance, and have an Application Load Balancer, and they can communicate with one another obviously, but they belong to account one. And account two and the account that has the VPC owner
    cannot see these resources. Likewise, account two can create EC2 instances within the account two, and account one cannot view these EC2 instances. 
  + We can also create an Amazon RDS database in our VPC owner account. And again, this will not be visible to any other accounts. 
  + The network is shared, so that means that, anything deployed in the VPC can talk to the other resources in the VPC. So that means that the applications can access each other using their private IP.
    They don't need to access each other over a public IP, and that could be a huge security benefit. 
  + We can even reference security groups to have a maximum amount of security across accounts, so that means that if we modify the security group of an Amazon RDS database to allow the security group of our EC2 instances 
    from account one, then our EC2 instance, is going to be able to access our Amazon RDS database from the VPC owner accounts. And if we allow again from the ALB in account one access to the EC2 instances in account two,
    then the EC2 instances in account two can access our ALB directly using its private IP, or private DNS.
  + Now we have shared an entire networking layer across multiple accounts, and we have made these resources talk to each other.
  + <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/RAM.png" width="60%" height="60%"/>
+ Handson - We go to Resource Access Manager or RAM. And then I'm going to create a resource share. We can share resources with other accounts, there are resources shared by me and shared with me.
  Let's create a resource share , MyFirstResourceShare. We can share an Aurora DB Cluster, Capacity Reservations, CodeBuild Projects, Dedicated Host, Image Builder, License Configurations, Resolver Rules,
  Resource Groups, Subnets, Traffic Mirror Targets and Transit Gateways. But VPC Subnets are important. There are no resources found, that's because I don't have a subnet that is not belonging to the default VPC.
  I could have shared subnet if I had one. Principals are optional and they determine which accounts should have access to my subnets that I've selected. And so it could be external accounts. We can give 
  account number, OU or organization. We can tag this resource here, and we are done. Once this is done, the other accounts will have to accept the resource share and then they can start using it.

#### AWS SSO

+ AWS Single Sign-On or SSO let's you centrally manage Single Sign-On to access multiple accounts and third-party business applications. So you're going to go your portal and once you're logged in to that Single Sign-On portal,
  you can log in to any of your AWS accounts, Dropbox, Office 365, Slack, without reentering your login. That's why it's called Single Sign-On.
+ https://aws.amazon.com/blogs/security/introducing-aws-single-sign-on/
+ You can log in once and you have access to all the things that Single Sign-On is configured to access. It is integrated with AWS organizations so if you have a tons of accounts within your organization,
  you just set up AWS Single Sign-On and you will have access to log in to all the accounts within that organization. So, one login for all the accounts.
+ It supports SAML 2.0 markup, so it has integration with SAML
+ Deep integration with on-premise Active Directory.
+ It's centralized permission management so you can manage all the permissions of users within Single Sign-On 
+ You get centralized auditing with CloudTrail for the logins.
+ use case talking about doing a sign-on to multiple AWS accounts or to business applications that require SAML 2.0, think Single Sign-On.
+ AWS SSO Setup with AD
	+ In the center we have Single Sign-On, so SSO, and we set up a connection to maybe our on-premise Active Directory, so we'll have an Active Directory on-premise, but we could also use Managed Services by AWS
	  or we can use Microsoft Managed AD by AWS to also manage our users from there. So we set up that trust and then, Single Sign-Ons know how to get the users from there. Then the users can connect to Single Sign-On
	  and from Single Sign-On, we can integrate it with different OUs and accounts within our organization. So, once we log in to Single Sign-On, we can access any organization accounts in here, but also we can access 
	  business cloud application that have deep integration with SSO such as Office 365, Dropbox and Slack, or we can even configure our own custom 2.0 compliance application. And with these SAML applications,
	  we can enable it to work with SSO. So the idea is that we log in once with SSO, it checks our login with our on-premise AD or our managed AD and then, we have access to AWS, business cloud applications and 
	  custom SAML application.
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/AWSADSSO.png" width="60%" height="60%"/>
+ SSO vs using the AssumeRoleWithSAML API
	+ If you use AssumeRoleWithSAML, we have to set up our third-party IDP login portal that will check our identity with the identity store and return to us a SAML 2.0 assertion, and then we have to send that 
	  SAML assertions to STS to use the right AssumeRoleWithSAML, and we get back security credentials and we are connected to AWS. But if you have multiple accounts on AWS, we need to set up this process
	  for each and every single accounts. On top of it, we have to manage this login portal and it's not a thing that may be available in your company just yet.
	+ But with SSO, a browser interface will log in through the login portal of SSO so we don't have to set up that login portal ourselves, this is the SSO service, and SSO is already integrated with your identity store
	  so we don't have to run anything here. They just talk to each other, they generate credentials for you, and you get credentials back right away, so it's one less piece of integration to do.
	  The really cool thing is that this SSO portal can give us credentials for one AWS account, but also many others. So, as soon as you wanna scale with a number of multiple accounts you wanna connect to, then SSO 
	  becomes an obvious choice.
	+ <img src="https://raw.githubusercontent.com/dhrub123/AWS/master/IAM/images/SSO_ROLE.png" width="60%" height="60%"/>
+ Handson - We go to AWS SSO and we can enable AWS SSO. 
	+ There are 3 steps to do.
		+ The first is to choose our identity source which is where we are going to administer our user end groups and it's going to be our active directory.
			+ We can have SSO itself as in identity source or active directory, or an external identity provider. So, we'll choose SSO right now cause its easier.
		+ The second one is to manage SSO to access all your AWS accounts that would be within your organization.
			+ I can click on manage SSO access to our organizations and we have access to a bunch of accounts within my organization. And I can say, "Okay, this will be the accounts "I am willing to access to."
		+ Then Manage SSO to access your cloud application or anything that is going to be SMAL 2.0 compatible.
			+ We can add applications. And there is a catalog of applications that already works with AWS SSO, or I can add a custom SAML 2.0 application in which case, I will need to specify a bunch of properties to properly configure it.
	+ Then I am given a user portal by SSO where I would have to login to once its been set-up. Once I am logged in through there, it would check my identity with identity source
	  and then, it would get SSO access to all the accounts and the cloud applications.
+ It is a free service of AWS and it saves you a lot of time and trouble. If you manage your users through AWS SSO, you could add them under Users in AWS SSO or you could add them under groups as well.
+ SSO is a really good candidates when you want to integrate your identity source with another identity source e.g. active director




